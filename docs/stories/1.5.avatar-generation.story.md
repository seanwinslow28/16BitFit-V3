# Story 1.5: Onboarding Flow - Photo Upload & AI Avatar Generation

**Epic:** 1 - Foundation & Core Loop Setup
**Story Points:** 13
**Status:** ‚è≥ Pending

## User Story

**As a** New User,
**I want** to upload a headshot photo and have the system generate my personalized Home Avatar by merging my face with the chosen archetype body,
**so that** I have a unique visual representation in the app.

## Acceptance Criteria

1. [ ] User is prompted to upload a headshot photo during onboarding
2. [ ] Photo upload functionality (camera/gallery access) is implemented
3. [ ] The uploaded photo and selected archetype are sent to the AI service (DALL-E 3) via a secure backend function (e.g., Supabase Edge Function)
4. [ ] The AI service successfully integrates the user's face onto the Stage 1 archetype body image
5. [ ] The generated avatar image URL is received and stored in the user's profile
6. [ ] A loading indicator is shown during generation (target < 15s)
7. [ ] Basic error handling for failed generation is implemented

## Technical Requirements

### Photo Upload

**Library:** `react-native-image-picker`

**Permissions:**
- Camera access (iOS: `NSCameraUsageDescription`)
- Photo library access (iOS: `NSPhotoLibraryUsageDescription`)

**Image Constraints:**
- Min resolution: 512x512
- Max file size: 5MB
- Formats: JPEG, PNG
- Face detection validation (optional)

### AI Avatar Generation

**Service:** OpenAI DALL-E 3 API

**Edge Function:** `apps/supabase-functions/generate-avatar/index.ts`

**Workflow:**
1. User uploads headshot
2. Upload to Supabase Storage
3. Call Edge Function with image URL + archetype
4. Edge Function calls DALL-E 3 with custom prompt
5. Return generated avatar URL
6. Store in user profile

**DALL-E 3 Prompt Template:**
```
"Create a pixel art Game Boy style character avatar in DMG color palette (4-color grayscale).
The character should be a [ARCHETYPE] with the following facial features from the provided photo: [face detected features].
Style: 16-bit pixel art, full body sprite, Stage 1 evolution, Game Boy DMG aesthetic, standing pose."
```

### Supabase Storage Buckets

1. **user-photos** (private)
   - Stores uploaded headshots
   - RLS: Users can only access own photos

2. **generated-avatars** (public)
   - Stores AI-generated avatars
   - Public read access
   - User-specific write via RLS

## Implementation Tasks

### 1. Photo Upload Screen

**File:** `apps/mobile-shell/src/screens/onboarding/PhotoUploadScreen.tsx`

```typescript
- Camera button
- Gallery button
- Preview uploaded photo
- "Generate My Avatar" button
- Loading state with progress indicator
- Error state with retry option
```

### 2. Image Service

**File:** `apps/mobile-shell/src/services/imageService.ts`

```typescript
- openCamera(): Promise<ImagePickerResponse>
- openGallery(): Promise<ImagePickerResponse>
- uploadPhoto(uri: string, userId: string): Promise<string>
- validateImage(uri: string): Promise<boolean>
```

### 3. Edge Function: generate-avatar

**File:** `apps/supabase-functions/generate-avatar/index.ts`

```typescript
serve(async (req) => {
  // 1. Verify auth
  const user = await getUser(req);

  // 2. Get request data
  const { photoUrl, archetype } = await req.json();

  // 3. Call DALL-E 3
  const response = await openai.images.generate({
    model: "dall-e-3",
    prompt: buildPrompt(archetype, photoUrl),
    size: "1024x1024",
    quality: "standard",
    n: 1,
  });

  // 4. Upload to Supabase Storage
  const avatarUrl = await uploadToStorage(response.data[0].url);

  // 5. Update user profile
  await updateUserProfile(user.id, { avatar_url: avatarUrl });

  // 6. Return URL
  return new Response(JSON.stringify({ avatarUrl }));
});
```

### 4. Environment Variables

Add to `.env`:
```
OPENAI_API_KEY=sk-...
```

Add to Supabase Edge Function secrets:
```bash
supabase secrets set OPENAI_API_KEY=sk-...
```

## User Flow

1. User completes archetype selection (Story 1.4)
2. Navigates to photo upload screen
3. Taps "Take Photo" or "Choose from Gallery"
4. Grants camera/photo permissions
5. Selects/captures photo
6. Reviews photo preview
7. Taps "Generate My Avatar"
8. Loading screen shows (< 15s target)
9. Avatar generation complete
10. Preview generated avatar
11. Taps "Looks Great!" to continue
12. Or "Try Again" to re-generate

## Error Handling

### Permission Denied
```typescript
if (!cameraPermission) {
  showAlert("Camera access required", "Please enable camera in Settings");
}
```

### Image Too Large
```typescript
if (fileSize > MAX_FILE_SIZE) {
  showAlert("Image too large", "Please select an image under 5MB");
}
```

### Generation Failed
```typescript
try {
  const avatar = await generateAvatar(photo, archetype);
} catch (error) {
  showAlert("Generation failed", "Please try again or choose a different photo");
  logError(error);
}
```

### Rate Limiting
```typescript
// Limit to 3 generation attempts per day
if (generationAttempts >= 3) {
  showAlert("Daily limit reached", "Try again tomorrow");
}
```

## Testing

### Manual Testing
1. Test camera capture on physical device
2. Test gallery selection
3. Test with various photo qualities
4. Test with/without face in photo
5. Test all 5 archetypes
6. Verify avatar quality
7. Test retry flow

### Edge Cases
- No face detected in photo
- Multiple faces in photo
- Poor lighting
- Extreme angles
- DALL-E API timeout
- Storage upload failure

## Cost Considerations

**DALL-E 3 Pricing:**
- $0.040 per image (1024x1024, standard quality)
- Budget: ~$100/month = 2,500 avatars
- Consider caching/retry limits

## Database Updates

```sql
-- Track avatar generation attempts
ALTER TABLE public.user_profiles
  ADD COLUMN avatar_generation_attempts INTEGER DEFAULT 0,
  ADD COLUMN avatar_generated_at TIMESTAMPTZ;
```

## Dependencies

- `react-native-image-picker`
- OpenAI DALL-E 3 API
- Supabase Storage
- Supabase Edge Functions (Deno)

## Next Story

**Story 1.6:** Combat Character Selection & Home Screen Display
