# Story 1.10: Basic FTUE & Tutorial Battle Integration

**Epic:** 1 - Foundation & Core Loop Setup
**Story Points:** 8
**Status:** ⏳ Pending

## User Story

**As a** New User,
**I want** the onboarding flow (including workout) to conclude with a brief tutorial battle against the Training Dummy, followed by a victory ceremony and landing on the Home Dashboard,
**so that** I understand the core loop and controls.

## Acceptance Criteria

1. [ ] The onboarding flow (incorporating Welcome, Intent, Avatar Creation [Story 1.5], Health Connect [Story 1.3], Daily Quest Assignment, Intro Workout, Workout Complete Ceremony) transitions smoothly into the tutorial segment
2. [ ] The tutorial briefly explains basic movement and attack controls
3. [ ] The tutorial initiates the first battle against the Training Dummy via the "Cartridge Load" animation
4. [ ] Completion of the tutorial battle includes a Victory Ceremony and transitions the user back to the Home Dashboard, displaying initial rewards
5. [ ] The entire FTUE (including tutorial battle) aims to be completable within ~3-5 minutes, with the initial setup (pre-workout) targeting <60 seconds (NFR11)

## FTUE Flow

```
1. Welcome Screen (5s)
   ↓
2. Profile Setup (20s)
   ↓
3. Archetype Selection (15s)
   ↓
4. Photo Upload & Avatar Generation (20s)
   ↓
5. Combat Character Selection (10s)
   ↓
6. Health Connect Permission (10s)
   ↓
7. Daily Quest Assignment (15s)
   ↓
8. Tutorial: Combat Controls (30s)   ← This Story
   ↓
9. First Battle (60-90s)              ← This Story
   ↓
10. Victory Ceremony (15s)             ← This Story
   ↓
11. Home Dashboard                     ← This Story
```

**Total Target Time:** 3-5 minutes

## Tutorial Implementation

### Tutorial Overlay

**File:** `apps/mobile-shell/src/components/TutorialOverlay.tsx`

```typescript
const TutorialSteps = [
  {
    id: 'movement',
    title: 'Movement',
    description: 'Use the D-Pad to move left and right',
    highlight: 'dpad',
    autoAdvance: false,
  },
  {
    id: 'jump',
    title: 'Jump',
    description: 'Press UP to jump over attacks',
    highlight: 'dpad-up',
    autoAdvance: false,
  },
  {
    id: 'punch',
    title: 'Punch',
    description: 'Tap the top buttons to punch',
    highlight: 'punch-buttons',
    autoAdvance: false,
  },
  {
    id: 'kick',
    title: 'Kick',
    description: 'Tap the bottom buttons to kick',
    highlight: 'kick-buttons',
    autoAdvance: false,
  },
  {
    id: 'energy',
    title: 'Energy System',
    description: 'Attacks use energy earned from your daily steps',
    highlight: 'energy-meter',
    autoAdvance: true,
    duration: 3000,
  },
  {
    id: 'ready',
    title: 'Ready to Battle!',
    description: 'Defeat the Training Dummy to complete the tutorial',
    autoAdvance: true,
    duration: 2000,
  },
];
```

### Daily Quest Assignment

**File:** `apps/mobile-shell/src/screens/onboarding/QuestAssignmentScreen.tsx`

```typescript
// Assign first quest based on archetype
const firstQuest = {
  trainer: 'Complete 30 minutes of exercise',
  runner: 'Walk or run 5,000 steps',
  yoga: 'Practice yoga for 20 minutes',
  bodybuilder: 'Complete a strength training session',
  cyclist: 'Cycle for 30 minutes',
};

// Show quest card with retro animation
<QuestCard
  title="Today's Quest"
  description={firstQuest[selectedArchetype]}
  reward="50 XP + Battle unlock"
/>
```

### Intro Workout Flow

**Simple Placeholder:**
```typescript
// For MVP, show mock workout screen
<WorkoutScreen
  title="Quick Warmup"
  duration={30} // 30 seconds
  onComplete={() => {
    // Award initial steps/energy
    awardSteps(100);
    navigateToTutorialBattle();
  }}
/>
```

**Future Enhancement:**
- Integrate actual workout tracking
- Use HealthKit/Connect data
- Real-time exercise guidance

### Tutorial Battle

**Phaser Scene: TutorialBattleScene**

```typescript
export class TutorialBattleScene extends BattleScene {
  create() {
    super.create();

    // Make training dummy extra passive
    this.dummy.setPassive(true);

    // Disable timer for tutorial
    this.timer.pause();

    // Enable tutorial hints
    this.enableTutorialMode();
  }

  private enableTutorialMode(): void {
    // Show hit markers
    // Slow down game speed slightly
    // Provide hints after inactivity

    this.time.addEvent({
      delay: 5000,
      callback: () => {
        if (this.playerHitCount === 0) {
          this.showHint('Try using Light Punch!');
        }
      },
    });
  }

  onVictory(): void {
    // Trigger victory ceremony
    this.scene.start('VictoryCeremonyScene', {
      playerHealth: this.player.health,
      damageDealt: this.totalDamage,
      firstVictory: true,
    });
  }
}
```

### Victory Ceremony

**File:** `apps/game-engine/src/scenes/VictoryCeremonyScene.ts`

```typescript
export class VictoryCeremonyScene extends Phaser.Scene {
  create(data: any) {
    // Show victory text
    this.add.text(400, 200, 'VICTORY!', {
      fontSize: '64px',
      color: '#ffff00',
    }).setOrigin(0.5);

    // Show rewards
    this.showRewards([
      { type: 'xp', amount: 50 },
      { type: 'coins', amount: 10 },
      { type: 'unlock', item: 'Battle Mode' },
    ]);

    // Play victory music
    this.sound.play('victory');

    // Character victory pose
    this.player.playAnimation('victory');

    // Auto-advance after 5 seconds
    this.time.delayedCall(5000, () => {
      this.returnToHomeScreen();
    });
  }

  private returnToHomeScreen(): void {
    // Send message to React Native
    bridge.send('TUTORIAL_COMPLETE', {
      rewards: this.rewards,
    });
  }
}
```

### Return to Home Dashboard

**File:** `apps/mobile-shell/src/screens/HomeScreen.tsx`

```typescript
// Listen for tutorial completion
useEffect(() => {
  const unsubscribe = bridge.on('TUTORIAL_COMPLETE', (data) => {
    // Mark onboarding as complete
    setOnboardingComplete(true);

    // Show rewards popup
    showRewardsModal(data.rewards);

    // Update user profile
    supabase
      .from('user_profiles')
      .update({ onboarding_completed: true })
      .eq('id', userId);
  });

  return unsubscribe;
}, []);
```

## Onboarding Completion Tracking

```sql
-- Add to user_profiles table
ALTER TABLE public.user_profiles
  ADD COLUMN tutorial_completed BOOLEAN DEFAULT false,
  ADD COLUMN tutorial_completed_at TIMESTAMPTZ;
```

```typescript
// Update on completion
await supabase
  .from('user_profiles')
  .update({
    tutorial_completed: true,
    tutorial_completed_at: new Date().toISOString(),
  })
  .eq('id', userId);
```

## Skip Tutorial Option

**For returning users or impatient users:**
```typescript
<TutorialOverlay
  onSkip={() => {
    setTutorialSkipped(true);
    navigateToHome();
  }}
/>
```

## Testing

1. **Full FTUE Flow:**
   - Complete all steps
   - Time the entire flow
   - Target: 3-5 minutes

2. **Tutorial Battle:**
   - Verify controls explained
   - Check tutorial hints appear
   - Confirm victory ceremony triggers

3. **Edge Cases:**
   - Skip tutorial
   - Close app mid-tutorial (resume)
   - Network failure during avatar generation

## Analytics Events

Track completion funnel:
```typescript
analytics.track('onboarding_started');
analytics.track('profile_created');
analytics.track('archetype_selected', { archetype });
analytics.track('avatar_generated');
analytics.track('health_connected', { granted: boolean });
analytics.track('tutorial_started');
analytics.track('tutorial_completed', { duration_seconds: 120 });
analytics.track('onboarding_completed', { total_duration: 300 });
```

## Dependencies

- Stories 1.1-1.9 complete
- All onboarding screens built
- Combat system functional

## Next Story

**Story 1.11:** Achieve 60fps Performance Target
