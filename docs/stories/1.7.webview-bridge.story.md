# Story 1.7: WebView Bridge & Basic Combat Scene Setup

**Epic:** 1 - Foundation & Core Loop Setup
**Story Points:** 13
**Status:** ⏳ Pending

## User Story

**As a** Developer,
**I want** to set up the React Native WebView component, implement the core "Hybrid Velocity Bridge" protocol, and load a basic Phaser 3 scene within the WebView,
**so that** the foundation for high-performance communication and gameplay is established.

## Acceptance Criteria

1. [ ] A dedicated WebView component is integrated into the React Native application
2. [ ] The core binary message protocol for the Hybrid Velocity Bridge is implemented on both the React Native and Phaser sides
3. [ ] Basic communication (e.g., sending a 'start game' event from RN to Phaser) is functional with low latency (<50ms target)
4. [ ] A basic Phaser 3 scene (e.g., PreloadScene, empty BattleScene) loads successfully within the WebView when navigating to the Battle screen
5. [ ] Navigation includes the "Cartridge Load" transition
6. [ ] Performance baseline (FPS, memory) is established for the empty scene

## Technical Architecture

### Hybrid Velocity Bridge Protocol

**Binary Message Format:**
```typescript
interface BridgeMessage {
  type: BridgeMessageType;
  payload?: any;
  timestamp: number;
  id: string;
}

enum BridgeMessageType {
  // RN → Phaser
  INIT_GAME = 'INIT_GAME',
  START_COMBAT = 'START_COMBAT',
  PLAYER_INPUT = 'PLAYER_INPUT',
  PAUSE_GAME = 'PAUSE_GAME',
  RESUME_GAME = 'RESUME_GAME',

  // Phaser → RN
  GAME_READY = 'GAME_READY',
  COMBAT_COMPLETE = 'COMBAT_COMPLETE',
  HEALTH_CHANGED = 'HEALTH_CHANGED',
  ROUND_END = 'ROUND_END',
}
```

### Implementation Files

**React Native Side:**
- `apps/mobile-shell/src/components/PhaserWebView.tsx`
- `apps/mobile-shell/src/services/bridgeService.ts`
- `apps/mobile-shell/src/screens/BattleScreen.tsx`

**Phaser Side:**
- `apps/game-engine/src/bridge/BridgeManager.ts`
- `apps/game-engine/src/scenes/PreloadScene.ts`
- `apps/game-engine/src/scenes/BattleScene.ts`

## Implementation Tasks

### 1. WebView Component

**File:** `apps/mobile-shell/src/components/PhaserWebView.tsx`

```typescript
import { WebView } from 'react-native-webview';

export const PhaserWebView: React.FC<Props> = ({ onMessage, onReady }) => {
  const webViewRef = useRef<WebView>(null);

  const sendMessage = useCallback((message: BridgeMessage) => {
    webViewRef.current?.injectJavaScript(`
      window.postMessage(${JSON.stringify(message)}, '*');
    `);
  }, []);

  return (
    <WebView
      ref={webViewRef}
      source={{ uri: GAME_ENGINE_URL }}
      onMessage={handleWebViewMessage}
      javaScriptEnabled
      domStorageEnabled
      allowsInlineMediaPlayback
    />
  );
};
```

### 2. Bridge Service

**File:** `apps/mobile-shell/src/services/bridgeService.ts`

```typescript
class BridgeService {
  private messageQueue: BridgeMessage[] = [];
  private listeners: Map<BridgeMessageType, Function[]>;

  send(type: BridgeMessageType, payload?: any): void {
    const message: BridgeMessage = {
      type,
      payload,
      timestamp: Date.now(),
      id: generateUUID(),
    };

    this.messageQueue.push(message);
    this.flush();
  }

  on(type: BridgeMessageType, callback: Function): void {
    if (!this.listeners.has(type)) {
      this.listeners.set(type, []);
    }
    this.listeners.get(type)!.push(callback);
  }

  private flush(): void {
    // Send queued messages to WebView
  }
}
```

### 3. Phaser Bridge Manager

**File:** `apps/game-engine/src/bridge/BridgeManager.ts`

```typescript
export class BridgeManager {
  private scene: Phaser.Scene;

  constructor(scene: Phaser.Scene) {
    this.scene = scene;
    this.setupMessageListener();
  }

  private setupMessageListener(): void {
    window.addEventListener('message', (event) => {
      const message: BridgeMessage = JSON.parse(event.data);
      this.handleMessage(message);
    });
  }

  private handleMessage(message: BridgeMessage): void {
    switch (message.type) {
      case 'INIT_GAME':
        this.initializeGame(message.payload);
        break;
      case 'START_COMBAT':
        this.startCombat(message.payload);
        break;
      // ...
    }
  }

  send(type: BridgeMessageType, payload?: any): void {
    const message: BridgeMessage = {
      type,
      payload,
      timestamp: Date.now(),
      id: this.generateId(),
    };

    // Send to React Native
    window.ReactNativeWebView?.postMessage(JSON.stringify(message));
  }
}
```

### 4. Phaser Scenes

**PreloadScene:**
```typescript
export class PreloadScene extends Phaser.Scene {
  create() {
    // Load assets
    this.load.image('background', 'assets/bg.png');
    this.load.spritesheet('sean', 'assets/sean.png', { frameWidth: 64, frameHeight: 64 });

    this.load.on('complete', () => {
      this.bridge.send('GAME_READY');
      this.scene.start('BattleScene');
    });
  }
}
```

**BattleScene:**
```typescript
export class BattleScene extends Phaser.Scene {
  private bridge: BridgeManager;

  create() {
    this.bridge = new BridgeManager(this);

    // Add background
    this.add.image(400, 300, 'background');

    // Placeholder for characters
    this.add.text(400, 300, 'Battle Scene Ready', {
      fontSize: '32px',
      color: '#fff',
    }).setOrigin(0.5);
  }
}
```

### 5. Cartridge Load Transition

**File:** `apps/mobile-shell/src/components/CartridgeTransition.tsx`

```typescript
// Animated transition mimicking Game Boy cartridge insertion
export const CartridgeTransition: React.FC = ({ onComplete }) => {
  return (
    <Animated.View style={animatedStyle}>
      <Image source={require('../assets/cartridge.png')} />
      <Text>Loading...</Text>
    </Animated.View>
  );
};
```

## Performance Targets

### Latency Measurement
```typescript
// Measure round-trip time
const startTime = Date.now();
bridge.send('PING');

bridge.on('PONG', () => {
  const latency = Date.now() - startTime;
  console.log(`Bridge latency: ${latency}ms`); // Target: < 50ms
});
```

### FPS Monitoring
```typescript
// In Phaser BattleScene
update() {
  const fps = this.game.loop.actualFps;
  if (fps < 55) {
    console.warn(`FPS dropped to ${fps}`);
  }
}
```

## Testing

1. **Latency Test:**
   - Send 100 messages RN → Phaser
   - Measure average round-trip time
   - Target: < 50ms

2. **Stability Test:**
   - Load BattleScene
   - Run for 5 minutes
   - Monitor memory usage
   - No crashes or memory leaks

3. **Performance Baseline:**
   - Empty BattleScene
   - Record FPS (target: 60fps)
   - Record memory (target: < 150MB)

## Dependencies

- `react-native-webview`
- Phaser 3.70.0+
- Webpack bundled game-engine

## Next Story

**Story 1.8:** Implement Core Combat Mechanics & Training Dummy
