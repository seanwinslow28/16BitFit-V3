# Story 1.9: Integrate Combat UI & Step-Energy Mechanic

**Epic:** 1 - Foundation & Core Loop Setup
**Story Points:** 8
**Status:** â³ Pending

## User Story

**As a** Player,
**I want** to see Health Bars, a timer, and my Energy Meter (fueled by synced steps) in the combat UI, and have the Energy Meter deplete/recharge appropriately,
**so that** core combat resources and status are visible and functional.

## Acceptance Criteria

1. [ ] Combat UI elements (Health Bars, Timer, Energy Meter) are implemented in the Phaser scene following SF2 style (NFR7)
2. [ ] Initial Health values are set for both characters
3. [ ] A round timer starts and counts down
4. [ ] The user's current step count (synced in Story 1.3) is used to determine the initial/max value of the Energy Meter
5. [ ] A basic mechanic for using/depleting energy (placeholder action) and potentially recharging it is implemented
6. [ ] The UI elements update correctly during gameplay (placeholder for damage/energy use)

## UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [P1 HEALTH â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] ðŸ”¥3  [P2 HEALTH] â”‚
â”‚                                          â”‚
â”‚     ROUND 1              TIMER: 99       â”‚
â”‚                                          â”‚
â”‚         [Sean]    vs    [Dummy]          â”‚
â”‚                                          â”‚
â”‚                                          â”‚
â”‚                                          â”‚
â”‚ ENERGY: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘           â”‚
â”‚ Steps: 7,234                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Combat UI Elements

### 1. Health Bars

**Position:** Top of screen
**Style:** Street Fighter 2 inspired
- Segments (10 bars)
- Depletes from right to left
- Color: Green â†’ Yellow â†’ Red based on percentage

```typescript
class HealthBar extends Phaser.GameObjects.Container {
  private maxHealth: number = 100;
  private currentHealth: number = 100;
  private segments: Phaser.GameObjects.Rectangle[];

  update(newHealth: number): void {
    const percentage = newHealth / this.maxHealth;
    const filledSegments = Math.ceil(percentage * 10);

    this.segments.forEach((seg, i) => {
      seg.setVisible(i < filledSegments);
      seg.setFillStyle(this.getColorForHealth(percentage));
    });
  }

  private getColorForHealth(percentage: number): number {
    if (percentage > 0.6) return 0x00ff00; // Green
    if (percentage > 0.3) return 0xffff00; // Yellow
    return 0xff0000; // Red
  }
}
```

### 2. Round Timer

**Position:** Top center
**Format:** "TIMER: 99"
**Countdown:** 99 seconds per round

```typescript
class RoundTimer extends Phaser.GameObjects.Text {
  private timeRemaining: number = 99;

  start(): void {
    this.scene.time.addEvent({
      delay: 1000,
      callback: () => {
        this.timeRemaining--;
        this.setText(`TIMER: ${this.timeRemaining}`);

        if (this.timeRemaining <= 0) {
          this.onTimeUp();
        }
      },
      loop: true,
    });
  }

  private onTimeUp(): void {
    // Determine winner by health
    this.scene.events.emit('ROUND_END');
  }
}
```

### 3. Energy Meter

**Position:** Bottom of screen
**Fuel Source:** Daily step count
**Formula:** `maxEnergy = Math.floor(dailySteps / 10)`
  - 0 steps = 0 energy
  - 1,000 steps = 100 energy
  - 10,000 steps = 1,000 energy

```typescript
class EnergyMeter extends Phaser.GameObjects.Container {
  private maxEnergy: number;
  private currentEnergy: number;
  private bar: Phaser.GameObjects.Rectangle;

  constructor(dailySteps: number) {
    super();
    this.maxEnergy = Math.floor(dailySteps / 10);
    this.currentEnergy = this.maxEnergy;
  }

  useEnergy(amount: number): boolean {
    if (this.currentEnergy >= amount) {
      this.currentEnergy -= amount;
      this.updateBar();
      return true;
    }
    return false; // Not enough energy
  }

  recharge(amount: number): void {
    this.currentEnergy = Math.min(this.currentEnergy + amount, this.maxEnergy);
    this.updateBar();
  }

  private updateBar(): void {
    const percentage = this.currentEnergy / this.maxEnergy;
    this.bar.width = 400 * percentage;

    // Change color based on energy level
    if (percentage < 0.2) {
      this.bar.setFillStyle(0xff0000); // Red (low)
    } else {
      this.bar.setFillStyle(0x00ffff); // Cyan (normal)
    }
  }
}
```

### 4. Combo Counter (Optional)

**Position:** Center screen (appears on combo)
**Shows:** Hit count and damage total

```typescript
class ComboCounter extends Phaser.GameObjects.Text {
  private hits: number = 0;
  private totalDamage: number = 0;

  addHit(damage: number): void {
    this.hits++;
    this.totalDamage += damage;
    this.setText(`${this.hits} HIT${this.hits > 1 ? 'S' : ''}!`);
    this.setVisible(true);

    // Auto-hide after 2 seconds
    this.scene.time.delayedCall(2000, () => {
      this.reset();
    });
  }

  reset(): void {
    this.hits = 0;
    this.totalDamage = 0;
    this.setVisible(false);
  }
}
```

## Energy Mechanics

### Energy Costs
- Light attacks: 5 energy
- Medium attacks: 10 energy
- Heavy attacks: 15 energy
- Special moves (future): 25-50 energy

### Energy Recharge
- Passive: +1 energy per second
- On hit: +5 energy
- On block: +2 energy

### No Energy Fallback
```typescript
if (!energyMeter.useEnergy(HEAVY_PUNCH_COST)) {
  // Not enough energy - play error sound
  this.sound.play('error');
  showMessage("Not enough energy!");
  return;
}
```

## Bridge Integration

**Pass step count from RN to Phaser:**
```typescript
// React Native
bridge.send('INIT_GAME', {
  combatCharacter: 'sean',
  dailySteps: 7234,
  opponentType: 'training_dummy',
});

// Phaser
handleInitGame(payload: any): void {
  this.energyMeter = new EnergyMeter(payload.dailySteps);
}
```

**Update energy on actions:**
```typescript
// When player attacks
bridge.send('PLAYER_INPUT', { action: 'HEAVY_PUNCH' });

// Phaser validates and uses energy
const used = this.energyMeter.useEnergy(15);
if (!used) {
  bridge.send('ACTION_FAILED', { reason: 'insufficient_energy' });
}
```

## Visual Polish

- **Damage Numbers:** Float upward on hit
- **Screen Shake:** On heavy attacks
- **Flash Effect:** On critical hits
- **Victory Pose:** When round ends

## Testing

1. **Health Depletion:**
   - Deal damage to dummy
   - Verify health bar depletes correctly
   - Check color changes

2. **Timer:**
   - Start round
   - Verify countdown
   - Check round end at 0

3. **Energy:**
   - Initialize with different step counts
   - Execute attacks
   - Verify energy depletion
   - Check recharge on hit/block

4. **UI Responsiveness:**
   - All updates happen within 1 frame (16ms)
   - No visual lag

## Dependencies

- Story 1.3 (Health data sync) for step count
- Story 1.8 (Combat mechanics) for attack execution
- Phaser UI components

## Next Story

**Story 1.10:** Basic FTUE & Tutorial Battle Integration
